{% extends 'cms/index.html' %}

{% block content %}

<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Create New Order</h1>
    </div>

    <!-- Order Form -->
    <form>

        <div class="row">
            <!-- Left Column -->
            <div class="col-12 col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Order Information</h6>
                    </div>
                    <div class="card-body">
                        <!-- Food Item -->
                        <!-- <div class="mb-3">
                            <label for="foodItem" class="form-label">Food Item</label>
                            <select class="selectpicker" id="foodItem" required>
                                <option selected disabled>Select Food Item</option>
                                <option value="Pizza Delicious">Pizza Delicious</option>
                                <option value="Burger Classic">Burger Classic</option>
                                <option value="Sandwich Delight">Sandwich Delight</option>
                            </select>
                        </div> -->

                        <!-- Quantity -->
                        <!-- <div class="mb-3">
                            <div class="row g-3">
                                
                                <div class="col-12 col-md-6 mb-3">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="quantity" placeholder="Enter quantity"
                                        required min="1" pattern="\d*"
                                        oninvalid="this.setCustomValidity('Please enter a valid number greater than 0')"
                                        oninput="this.setCustomValidity('')">
                                </div>
                            </div>
                        </div> -->

                        <div id="item-list">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="item-name-0" class="form-label">Item Name</label>
                                    <input type="text" class="form-control item-name" id="item-name-0"
                                        placeholder="Enter item name" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="item-qty-0" class="form-label">Quantity</label>
                                    <input type="number" class="form-control item-qty" id="item-qty-0" value="1" min="1"
                                        required>
                                </div>
                                <div class="col-md-4 d-flex align-items-end mt-1">
                                    <button id="add-item" class="btn btn-primary me-2" type="button">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button id="remove-item" class="btn btn-danger remove-item" type="button" disabled>
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="output" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Customer Information</h6>
                    </div>
                    <div class="card-body">
                        <!-- Name -->
                        <div class="mb-3">
                            <label for="customerName" class="form-label">Customer Name</label>
                            <input type="text" class="form-control" id="customerName" placeholder="Enter customer name"
                                required>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="customerEmail" class="form-label">Customer Email</label>
                            <input type="email" class="form-control" id="customerEmail" placeholder="Enter email"
                                required>
                        </div>

                        <!-- Phone -->
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="customerPhone" placeholder="Enter phone number"
                                required>
                        </div>

                        <!-- Pickup Timing -->
                        <div class="col-12 col-md-6">
                            <label for="pickupTime" class="form-label">Pickup Timing</label>
                            <select class="selectpicker" id="pickupTime" required>
                                <option selected disabled>Choose a time range</option>
                                <option value="10-15 mins">10-15 mins</option>
                                <option value="20-30 mins">20-30 mins</option>
                                <option value="30-45 mins">30-45 mins</option>
                                <option value="1 hour">1 hour</option>
                            </select>
                        </div>

                        <!-- Instructions -->
                        <div class="mb-3">
                            <label for="instructions" class="form-label">Special Instructions</label>
                            <textarea class="form-control" id="instructions" rows="2"
                                placeholder="Any special instructions (e.g., extra cheese, no olives)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Selection -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Select Delivery Location</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="travel-times" class="form-label">Estimated Travel Times</label>
                            <div id="travel-times" class="border p-2">
                                <p>Fetching travel times...</p>
                            </div>

                            <label for="location" class="form-label">Select Your Location</label>
                            <div id="map" class="border border-2 border-primary" style="height: 300px; width: 100%;">
                            </div>
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                        </div>
                        <small class="text-muted d-block mt-2">Drag the pin on the map to select the current
                            location.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save"></i> Submit Order</button>
        </div>
    </form>

</div>

<style>
    #map {
        height: 400px;
        width: 100%;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    #travel-times {
        background-color: #f8f9fa;
        border: 1px solid #e3e3e3;
        border-radius: 5px;
        font-size: 0.9rem;
    }
</style>

<script>

    document.addEventListener('DOMContentLoaded', () => {

        //recipe items structure
        let itemCount = 1;
        const itemList = document.getElementById('item-list');
        const addItemButton = document.getElementById('add-item');
        const submitItemsButton = document.getElementById('submit-items');
        const outputDiv = document.getElementById("output");

        addItemButton.addEventListener('click', function () {
            console.log('add item button clicked');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-3';
            newRow.innerHTML = `
                    <div class="col-md-5">
                        <label for="item-name-${itemCount}" class="form-label">Item Name</label>
                        <input type="text" class="form-control item-name" id="item-name-${itemCount}" placeholder="Enter item name">
                    </div>
                    <div class="col-md-3">
                        <label for="item-qty-${itemCount}" class="form-label">Quantity</label>
                        <input type="number" class="form-control item-qty" id="item-qty-${itemCount}" value="1" min="1">
                    </div>
                    <div class="col-md-4 d-flex align-items-end mt-1">
                        <button id="add-item" class="btn btn-primary me-2" type="button">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button id="remove-item" class="btn btn-danger remove-item" type="button">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                `;
            itemList.appendChild(newRow);
            itemCount++;

            //Enable remove button for the first item if more than one item is there
            if (itemCount > 1) {
                document.querySelector("#item-list .row:first-child .remove-item").disabled = false;
            }
        });

        itemList.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-item')) {
                event.target.closest('.row').remove();
                itemCount--;
                if (itemCount == 1) {
                    document.querySelector("#item-list .row:first-child .remove-item").disabled = true;
                }
            }
        });

        // submitItemsButton.addEventListener("click", function () {
        //     const items = [];
        //     const itemNameInputs = document.querySelectorAll(".item-name");
        //     const itemQtyInputs = document.querySelectorAll(".item-qty");

        //     for (let i = 0; i < itemNameInputs.length; i++) {
        //         items.push({ name: itemNameInputs[i].value, qty: itemQtyInputs[i].value });
        //     }
        //     outputDiv.innerHTML = `<pre>${JSON.stringify(items, null, 2)}</pre>`;
        // });


        // map location section
        const shopLocation = [22.767697, 88.541460]; // Replace with your shop's coordinates
        let userLocation;

        // Initialize the map
        const map = L.map('map').setView([0, 0], 16);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            // maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add a marker to the map
        const marker = L.marker([0, 0], { draggable: true }).addTo(map);

        // Get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    userLocation = [latitude, longitude];
                    console.log('user location is ', userLocation);
                    console.log('shop location is ', shopLocation);
                    // Add a marker for the user
                    // const userMarker = L.marker(userLocation).addTo(map).bindPopup('My Location').openPopup();

                    // Adjust map view to include both locations
                    const bounds = L.latLngBounds([shopLocation, userLocation]);
                    map.fitBounds(bounds);

                    // Add routing from shop to user
                    L.Routing.control({
                        waypoints: [L.latLng(shopLocation), L.latLng(userLocation)],
                        routeWhileDragging: true,
                        showAlternatives: true,

                        createMarker: function (i, waypoint, n) {
                            const icons = ['📍 Shop', '🚶 You'];
                            return L.marker(waypoint.latLng).bindPopup(icons[i]);
                        },
                    }).addTo(map);
                    L.control.scale({ position: 'bottomright' }).remove();
                    // Calculate travel times for walking and two-wheeler
                    calculateTravelTimes(shopLocation, userLocation);
                },
                (error) => {
                    console.error('Geolocation error:', error.message);
                    alert('Unable to fetch location. Please enable location services.');
                },
                // {
                //     enableHighAccuracy: true, // Request high accuracy
                //     timeout: 10000,          // Set a timeout (in milliseconds)
                //     maximumAge: 0            // Disable caching of location
                // }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }

        // Update latitude and longitude when the marker is dragged
        marker.on('moveend', (e) => {
            const { lat, lng } = e.target.getLatLng();
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
        });
    });


    // Function to calculate travel times
    function calculateTravelTimes(shop, user) {
        const distance = getDistance(shop[0], shop[1], user[0], user[1]); // Distance in km

        // Average speeds (in km/h)
        const walkingSpeed = 5;
        const twoWheelerSpeed = 40;

        // Time = Distance / Speed (in hours)
        const walkingTime = (distance / walkingSpeed) * 60; // Minutes
        const twoWheelerTime = (distance / twoWheelerSpeed) * 60; // Minutes

        // Display travel times
        document.getElementById('travel-times').innerHTML = `
        <p><strong>Walking:</strong> ${walkingTime.toFixed(2)} minutes</p>
        <p><strong>Two-wheeler:</strong> ${twoWheelerTime.toFixed(2)} minutes</p>
    `;
    }

    // Function to calculate distance between two points (Haversine formula)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
    }


    function foodItemFormUpdate() {

    }


</script>


{% endblock content %}